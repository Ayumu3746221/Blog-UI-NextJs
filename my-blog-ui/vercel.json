{
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/next",
      "config": {
        "env": {
          "GOOGLE_APPLICATION_CREDENTIALS": "/tmp/service-account.json",
          "INSTANCE_CONNECTION_NAME": "$INST_CONN_NAME"
        }
      }
    }
  ],
  "images": {
    "cloud-sql-proxy": {
      "ports": [5432],
      "entrypoint": ["/cloud_sql_proxy", "-instances=$INST_CONN_NAME=tcp:5432"]
    }
  },
  "deployHooks": {
    "beforeBuild": [
      "gcloud auth activate-service-account --key-file=/tmp/gcloud-auth.json",
      "gcloud secrets versions access latest --secret=cloud-sql-service-account-key --project=$PROJECT_ID > /tmp/service-account.json"
    ]
  }
}
